<script>
// âš ï¸ PASTE YOUR NEW DEPLOYMENT URL HERE
const API_URL = "https://script.google.com/macros/s/YOUR_NEW_ID_HERE/exec"; 

let sessionPass = ""; // We store what you typed temporarily

function login() {
  const input = document.getElementById("adminPass").value;
  const btn = document.querySelector(".btn-green");
  
  // UI Loading State
  btn.innerText = "Verifying...";
  btn.disabled = true;

  // Send the input to Google to check
  fetch(API_URL + "?action=read&password=" + input)
    .then(res => res.json())
    .then(response => {
      if (response.result === "success") {
        // Password was correct!
        sessionPass = input; // Save it for this session
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        renderTable(response.data); // Load the data we just got
      } else {
        alert("âŒ Wrong Password!");
        btn.innerText = "Enter Dashboard";
        btn.disabled = false;
      }
    })
    .catch(err => {
      alert("Server Error. Check Internet.");
      btn.innerText = "Enter Dashboard";
      btn.disabled = false;
    });
}

function loadData() {
  // Use the saved password to ask for data again
  fetch(API_URL + "?action=read&password=" + sessionPass)
    .then(res => res.json())
    .then(response => {
      if (response.result === "success") {
        renderTable(response.data);
      }
    });
}

function renderTable(data) {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  // Data mapping depends on your sheet columns
  // Assuming: [Date, PromoterCode, LeadPhone, LeadUPI, AppName, Status, Commission]
  
  data.reverse().forEach(row => {
    const phone = row[2]; 
    const app = row[4];
    const ref = row[1];
    const upi = row[3]; 
    const status = row[5] || "Pending"; 

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(row[0]).toLocaleDateString()}</td>
      <td>
        <div style="font-weight:bold;">${phone}</div>
        <div style="font-size:11px; color:#666;">${upi}</div>
      </td>
      <td style="color:var(--green)">${app}</td>
      <td>${ref}</td>
      <td><span class="status-badge ${status.toLowerCase()}">${status}</span></td>
      <td>
        ${status !== "Approved" ? 
          `<button class="action-btn btn-green" onclick="approveUser('${phone}', this)">Approve âœ…</button>` : 
          `<span style="color:#444; font-size:12px;">Done</span>`
        }
        <a href="upi://pay?pa=${upi}&pn=User&am=100&cu=INR" class="action-btn pay-btn">Pay ðŸ’¸</a>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function approveUser(phone, btn) {
  if(!confirm("Mark this user as Approved?")) return;

  btn.innerText = "...";
  
  fetch(API_URL, {
    method: "POST",
    mode: "no-cors", 
    body: JSON.stringify({
      action: "approve",
      password: sessionPass, // Send the password with the command
      phone: phone
    })
  }).then(() => {
    alert("âœ… User Approved!");
    btn.parentElement.innerHTML = '<span class="status-badge approved">Approved</span>';
  });
}
</script>
