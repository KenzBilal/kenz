<!DOCTYPE html>
<html>
<head>
    <title>CashTree | Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        .card { background: #1e1e1e; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; }
        .btn-approve { background: #28a745; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
        .btn-reject { background: #dc3545; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; margin-left: 10px; }
        h1 { color: #00ff88; }
    </style>
</head>
<body>
    <h1>Lead Approval Panel</h1>
    <div id="leadsList">Loading pending leads...</div>

    <script>
        const supabaseUrl = 'https://qzjvratinjirrcmgzjlx.supabase.co';
        const supabaseKey = 'sb_publishable_AB7iUKxOU50vnoqllSfAnQ_Wdji8gEc';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function fetchLeads() {
            // This query gets the lead + the app name + the promoter's name all at once
            const { data, error } = await supabase
                .from('leads')
                .select(`
                    id, lead_phone, status,
                    promoters ( full_name, username ),
                    campaigns ( app_name, promoter_payout )
                `)
                .eq('status', 'pending');

            const container = document.getElementById("leadsList");
            if (data.length === 0) { container.innerHTML = "No pending leads! Good job."; return; }

            container.innerHTML = data.map(lead => `
                <div class="card">
                    <h3>App: ${lead.campaigns.app_name}</h3>
                    <p>Promoter: ${lead.promoters.full_name} (${lead.promoters.username})</p>
                    <p>User Phone: ${lead.lead_phone}</p>
                    <button class="btn-approve" onclick="approveLead('${lead.id}', '${lead.promoters.id}', ${lead.campaigns.promoter_payout})">Approve ✅</button>
                    <button class="btn-reject" onclick="rejectLead('${lead.id}')">Reject ❌</button>
                </div>
            `).join('');
        }

        async function approveLead(leadId, promoterId, amount) {
            // 1. Update status to 'approved'
            await supabase.from('leads').update({ status: 'approved' }).eq('id', leadId);
            // 2. Call the wallet function we just made
            await supabase.rpc('increment_wallet', { row_id: promoterId, amount: amount });
            alert("Approved! Wallet updated.");
            fetchLeads();
        }

        async function rejectLead(leadId) {
            await supabase.from('leads').update({ status: 'rejected' }).eq('id', leadId);
            alert("Lead rejected.");
            fetchLeads();
        }

        fetchLeads();
    </script>
</body>
</html>
